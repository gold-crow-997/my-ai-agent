> ‚ö†Ô∏è Kindly review the docs once more before saving.

## Email Responder
![Latest-0.0.1](https://img.shields.io/badge/Latest-0.0.1-blue)

The **Email Responder** is an automated AI-driven workflow designed to process incoming Gmail messages, generate polite and brand-aligned draft replies using advanced AI (Google Gemini), and manage review and sending of those replies effectively. It integrates Gmail, Google Sheets as a knowledge base, Airtable for review logging, and Telegram for receiving reviewer decisions.

![Email Responder screenshot](./workflow.png)

> ‚ö†Ô∏è Note: This image is a sample and does not represent the actual workflow

---

### üí° Why Use Email Responder?
- Automates email reply drafting with AI, saving time and ensuring consistent brand voice.
- Integrates company knowledge base for factually accurate responses.
- Supports human review process through Telegram-based approval or rejection.
- Logs reviewer decisions and actions in Airtable for audit and analytics.
- Maintains clean Gmail inboxes by managing drafts and sent messages automatically.
- Scalable with strong error handling and webhook standards compliance.

---

### ‚ö° Who Is This For?
- Customer support teams seeking faster, consistent email responses.
- Small to medium businesses aiming to automate routine email handling.
- Developers and automation engineers implementing AI-assisted communication workflows.
- Teams requiring an audit trail of email responses and reviewer decisions.
- Anyone looking to integrate AI-generated content with Gmail and cloud tools in n8n.

---

### ‚ùì What Problem Does It Solve?
Manually replying to customer emails can be time-consuming and inconsistent. This workflow leverages AI to draft professional replies based on both the email content and official company information, then routes these drafts for human approval, automating routine tasks while preserving quality and control.

---

### üîß How This Workflow Works
1. **Trigger on new incoming Gmail emails** via the **Gmail Trigger** node.
2. **Extract key metadata** (subject, sender, date, snippet) from incoming emails using a **Code** node.
3. **Fetch full original Gmail message** to get detailed content.
4. **Map extracted email data** to a structured input format for the AI agent.
5. **Invoke the AI Agent node** configured with a prompt to generate draft replies:
   - Reads the original email.
   - Looks up company services in Google Sheets knowledge base if needed.
   - Drafts a polite, brand-consistent reply as structured JSON.
6. **Call Google Gemini language model** for draft generation through **LangChain integration**.
7. **Save the AI-generated draft** in Gmail as a reply draft.
8. **Wait for reviewer decisions** via Telegram bot input:
   - Reviewer approves or rejects reply using Telegram callbacks.
9. **Process reviewer decisions**:
   - If approved, fetch the draft and send the reply via Gmail.
   - If rejected, delete the draft.
10. **Log all review actions** (approve/reject) with message and draft IDs in Airtable.
11. **Webhook & API key validation** present to meet NMS standards, supporting external triggers or development notes.

---

### üîê Setup Instructions
- ‚úÖ **Environment Variable:**  
  Set `EMAIL_RESPONDER_API_KEY` (e.g., `"email_responder_test_key"`) for webhook validation.

- ‚úÖ **Gmail OAuth2 Credential:**  
  Configure Gmail OAuth credentials inside n8n credential manager for Gmail Trigger, message fetching, drafting, and sending.

- ‚úÖ **Google Sheets OAuth2 Credential:**  
  Connect to your Google Sheets knowledge base containing service descriptions for factual lookup.

- ‚úÖ **Airtable OAuth2 Credential:**  
  Set up to log reviewer actions in an Airtable base and table dedicated to email review logs.

- ‚úÖ **Google Gemini API Key:**  
  Insert Gemini API credentials required for the AI language model node.

- ‚úÖ **Telegram Bot Credentials:**  
  Configure Telegram Bot token and API for handling reviewer responses via chat callbacks.

- ‚úÖ **Webhook Configuration:**  
  The webhook node acts as an API entry point to validate requests (with API key) and respond with developer notes. It does not start the email flow.

---

### üìÖ Payload
| Key       | Definition                          |
|-----------|-----------------------------------|
| subject   | Subject line of reply email       |
| body      | Body content of the reply email   |
| To        | Recipient email address (original email sender) |
| uid       | Unique Telegram callback ID for review |
| action    | Review action: "approve" or "reject" |
| draftId   | Gmail Draft ID generated by AI    |
| messageId | Gmail Message ID of the original email |

**Example JSON Payload for AI Output:**
```json
{
  "subject": "string",
  "body": "string",
  "To": "<email address>"
}
```

**Example cURL Test for Webhook Validation:**
```bash
curl -X POST 'https://n8n.popapps.ai/webhook-test/email-responder' \
-H 'Content-Type: application/json' \
-d '{"apiKey": "email_responder_test_key"}'
```

---

### üî® Tools/Node Used
- **Gmail Trigger:** Detect new incoming emails using Gmail OAuth.
- **Code (JavaScript):** Extract and parse email metadata for structured input.
- **Gmail Node:** Fetch original emails, save drafts, send emails, delete drafts.
- **LangChain Agent Node:** Generate AI draft replies based on defined prompt instructions.
- **Google Gemini Chat Model:** Advanced language model for natural, brand-consistent response generation.
- **Google Sheets Tool:** Lookup service info and descriptions from official company knowledge base.
- **Telegram Trigger:** Receive reviewer responses (approve/reject) through Telegram bot callbacks.
- **Code Node:** Parse Telegram callback data into structured variables.
- **Airtable Node:** Search and log review decisions to an Airtable base for auditing.
- **Webhook Node:** Validate incoming API requests and provide developer notes.
- **Respond to Webhook:** Send API response messages.

---

### ‚öôÔ∏è Reactive & Proactive Behavior
- **Reactive:** Triggered immediately on new Gmail emails or Telegram review callbacks.
- **Proactive:** AI drafts replies automatically, and workflow waits for human input before sending or deleting drafts.
- **Fallback:** Retries AI generation on failure, leverages webhook validation to restrict access.

---

### üêû Error Handling
- API key validation errors result in immediate workflow failure with an unauthorized error.
- AI generation has retry enabled to handle transient issues.
- Gmail and Airtable node errors will halt processing (visible in n8n executions).
- If reviewer rejects, the draft is deleted to avoid clutter.
- Duplicate processing prevented by checking existing review logs in Airtable.

---

### üß© Requirements
- Active Gmail OAuth2 credentials with permission to read, draft, send, and delete emails.
- Google Sheets OAuth2 access to the company knowledge base spreadsheet.
- Airtable API key with write access to review logs table.
- Google Gemini API key for language model use.
- Telegram Bot configured with webhook URL for reviewer responses.
- Environment variable `EMAIL_RESPONDER_API_KEY` set in n8n instance.
- n8n environment able to communicate with Gmail, Google Sheets, Airtable, Gemini, and Telegram APIs.

---

### üìö Resources
- [n8n Gmail Node Documentation](https://docs.n8n.io/integrations/builtin/app-nodes/n8n-nodes-base.gmail/)
- [LangChain Agent Integration](https://docs.n8n.io/integrations/ai/langchain/)
- [Google Sheets n8n Node](https://docs.n8n.io/integrations/builtin/app-nodes/n8n-nodes-base.google-sheets/)
- [Airtable API Docs](https://airtable.com/api)
- [Telegram Bot API](https://core.telegram.org/bots/api)
- [Google Gemini API](https://developers.google.com/palm)

---

### üêû Troubleshooting
- **Unauthorized webhook calls:** Verify `EMAIL_RESPONDER_API_KEY` matches between environment and request.
- **Drafts not created:** Confirm Gmail OAuth scopes and credentials are valid.
- **AI drafts low quality or errors:** Check Gemini API key validity and LangChain node logs.
- **Reviewer input not processed:** Ensure Telegram webhook URL is correct and bot token is active.
- **Duplicate logs in Airtable:** Confirm filter formula on UID value and uniqueness logic.
- **Delayed email triggers:** Gmail polling set to every minute; wait or increase trigger frequency.
- **Webhook not triggering:** Validate webhook URL and that it‚Äôs enabled in n8n.
- **Draft deletion not occurring:** Check Gmail OAuth permissions for deleting drafts.
- **Google Sheets data not found:** Validate Sheet ID and named ranges match those configured.
- **If AI output parsing fails:** Inspect LangChain structured output parser node and prompt formatting.

---

> ‚ÑπÔ∏è This section can be removed once you're fully satisfied with the content

### üìå Recommended Improvements
- Give descriptive names to code nodes, e.g. rename "`Extract Email Metadata`" to "`Parse Incoming Email Metadata`" for clarity.
- Add comments in code nodes for better maintainability.
- Parameterize the Google Sheets document ID and sheet name for easy updates.
- Add error handling node to catch and notify on failures by email or Telegram.
- Maintain draft expiration logic to auto-clean stale drafts (add TTL logic).
- Include environment variable for review Telegram bot username.
- Extend AI prompt with dynamic parameter inputs for tone or language style.
- Add Slack or Microsoft Teams notification node for reviewer alerts.
- Add toggle nodes to enable/disable auto-send after review for testing.
- Implement retry logic on Gmail API rate limit exceed errors.
- Provide a configuration dashboard or credentials overview note within n8n.
- Use named JSON schemas for AI output validation instead of inline examples.
- Include unit tests or execution samples in documentation.
- Document all environment variables and credentials explicitly at the start.
- Enable multi-language support by parameterizing prompt language.

# END